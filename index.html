<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KHATA PRO - V15 MOBILE FIX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        
        body.dark-mode { background: #0f172a; color: #f8fafc; }
        body.light-mode { background: #f8fafc; color: #0f172a; }

        .app { max-width: 480px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; position: relative; }
        
        .dashboard-card { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); padding: 40px 25px; border-radius: 0 0 40px 40px; text-align: center; box-shadow: 0 15px 30px rgba(30, 64, 175, 0.4); margin-bottom: 25px; }
        .balance-amount { font-size: 48px; font-weight: 800; margin: 10px 0 25px 0; color: white; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 20px; backdrop-filter: blur(5px); }

        .search-wrap { padding: 0 20px; margin-top: -45px; z-index: 10; margin-bottom: 20px; position: relative; }
        .search-box { width: 100%; padding: 18px 20px 18px 50px; border-radius: 25px; border: none; box-shadow: 0 10px 25px rgba(0,0,0,0.1); outline: none; font-size: 16px; }
        .dark-mode .search-box { background: #1e293b; color: white; }
        .light-mode .search-box { background: white; color: black; }

        .list-container { padding: 10px 20px; flex: 1; overflow-y: auto; padding-bottom: 120px; }
        
        /* Mobile Optimized Click Areas */
        .cust-card, .trans-card, .btn-action, .fab, button { cursor: pointer; user-select: none; }
        .cust-card:active, .trans-card:active { background: rgba(128,128,128,0.1); transform: scale(0.98); }

        .cust-card { display: flex; align-items: center; padding: 18px; border-radius: 24px; margin-bottom: 15px; transition: 0.1s; }
        .dark-mode .cust-card { background: #1e293b; border: 1px solid rgba(255,255,255,0.05); }
        .light-mode .cust-card { background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }

        .avatar { width: 50px; height: 50px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-weight: 800; color: white; margin-right: 15px; font-size: 20px; }
        .trans-card { display: grid; grid-template-columns: 105px 1fr 1fr 1fr 30px; padding: 18px; border-radius: 20px; margin-bottom: 10px; align-items: center; font-size: 13px; gap: 5px; }
        .dark-mode .trans-card { background: #1e293b; }
        .light-mode .trans-card { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: flex-end; z-index: 1000; backdrop-filter: blur(8px); }
        .modal { width: 100%; max-width: 480px; padding: 30px 25px 45px 25px; border-radius: 40px 40px 0 0; transform: translateY(100%); transition: transform 0.3s ease-out; position: relative; }
        .modal.active { transform: translateY(0); }
        .dark-mode .modal { background: #1e293b; border-top: 1px solid rgba(255,255,255,0.1); }
        .light-mode .modal { background: #ffffff; }

        .input-group { margin-bottom: 15px; }
        .input-label { font-size: 10px; font-weight: 700; opacity: 0.5; text-transform: uppercase; margin-left: 5px; margin-bottom: 5px; display: block; }
        .input-field { width: 100%; padding: 16px; border-radius: 18px; border: 2px solid transparent; background: rgba(128,128,128,0.1); color: inherit; outline: none; font-size: 16px; font-weight: 600; }
        
        .fab { position: fixed; bottom: 35px; right: 25px; width: 65px; height: 65px; background: #2563eb; color: white; border-radius: 22px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4); z-index: 100; border: none; }
        .footer { position: fixed; bottom: 30px; width: 100%; max-width: 480px; padding: 0 20px; display: flex; gap: 15px; z-index: 100; }
        .btn-action { flex: 1; padding: 18px; border-radius: 20px; font-size: 16px; font-weight: 800; color: white; border: none; text-align: center; }

        @media print { .no-print { display: none !important; } #printArea { display: block !important; } }
        #printArea { display: none; padding: 20px; background: white; color: black; }
    </style>
</head>
<body class="dark-mode">

    <div class="app no-print">
        <div class="p-6 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <button id="backBtn" onclick="goHome()" class="hidden text-xl p-2"><i class="fa-solid fa-arrow-left"></i></button>
                <h1 id="pageTitle" class="text-xl font-extrabold">KHATA PRO</h1>
            </div>
            <div class="flex gap-6 items-center">
                <button onclick="toggleTheme()" class="p-2"><i id="themeIcon" class="fa-solid fa-sun text-xl"></i></button>
                <button onclick="openBackup()" class="p-2"><i class="fa-solid fa-cloud-arrow-down text-xl"></i></button>
            </div>
        </div>

        <div id="mainContent" class="flex-1 overflow-y-auto"></div>
        <div id="footerActions"></div>
    </div>

    <div id="printArea">
        <h1 id="pCustName" style="font-size: 22px; font-weight: bold;"></h1>
        <p id="pPhone"></p><p id="pDateLabel"></p>
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <thead><tr style="border-bottom: 2px solid #000;"><th>Date</th><th>Remark</th><th>Out</th><th>In</th><th>Bal</th></tr></thead>
            <tbody id="pBody"></tbody>
        </table>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modalBox"></div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('KHATA_PRO_V15')) || { customers: [], trans: [], darkMode: true };
        let activeCid = null;
        let searchQuery = "";

        // Core Functions
        const saveDB = () => { localStorage.setItem('KHATA_PRO_V15', JSON.stringify(db)); render(); };
        const toggleTheme = () => { db.darkMode = !db.darkMode; applyTheme(); saveDB(); };
        const applyTheme = () => {
            document.body.className = db.darkMode ? 'dark-mode' : 'light-mode';
            document.getElementById('themeIcon').className = db.darkMode ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        };

        const fmtDate = (d) => {
            const dt = new Date(d);
            return `${String(dt.getDate()).padStart(2, '0')}/${String(dt.getMonth() + 1).padStart(2, '0')}/${dt.getFullYear()}`;
        };

        const render = () => activeCid ? renderDetails() : renderHome();

        function renderHome() {
            activeCid = null;
            document.getElementById('backBtn').classList.add('hidden');
            document.getElementById('pageTitle').innerText = "KHATA PRO";
            let give = 0, got = 0;
            db.trans.forEach(t => t.type === 'GAVE' ? give += t.amt : got += t.amt);

            document.getElementById('mainContent').innerHTML = `
                <div class="dashboard-card">
                    <div class="text-[11px] font-bold opacity-70 uppercase tracking-widest">Global Net Balance</div>
                    <div class="balance-amount">₹${give - got}</div>
                    <div class="stat-grid">
                        <div><span class="block text-[9px] opacity-70">GIVE (OUT)</span><span class="font-bold text-red-200 text-lg">₹${give}</span></div>
                        <div style="border-left: 1px solid rgba(255,255,255,0.2)"><span class="block text-[9px] opacity-70">GET (IN)</span><span class="font-bold text-green-200 text-lg">₹${got}</span></div>
                    </div>
                </div>
                <div class="search-wrap">
                    <i class="fa-solid fa-search absolute left-10 top-1/2 -translate-y-1/2 opacity-30"></i>
                    <input type="text" class="search-box" placeholder="Search customer..." oninput="searchQuery=this.value; renderHomeList()">
                </div>
                <div class="list-container" id="custContainer"></div>
                <button class="fab" onclick="openCustomerModal()"><i class="fa-solid fa-plus"></i></button>`;
            document.getElementById('footerActions').innerHTML = '';
            renderHomeList();
        }

        function renderHomeList() {
            const container = document.getElementById('custContainer');
            let filtered = db.customers.filter(c => c.name.toLowerCase().includes(searchQuery.toLowerCase()));
            let html = `<h3 class="text-[10px] font-black opacity-30 mb-4 uppercase tracking-widest">Directory</h3>`;
            filtered.forEach((c, i) => {
                let bal = 0;
                db.trans.filter(t => t.cid === c.id).forEach(t => bal += (t.type === 'GAVE' ? t.amt : -t.amt));
                html += `
                    <div class="cust-card" onclick="viewCust(${c.id})">
                        <div class="avatar" style="background:hsl(${i * 45}, 70%, 50%)">${c.name.charAt(0).toUpperCase()}</div>
                        <div class="flex-1">
                            <b class="text-base block font-bold">${c.name}</b>
                            <small class="opacity-40 font-bold">${c.phone || 'No Number'}</small>
                        </div>
                        <div class="text-right flex items-center gap-3">
                            <div class="text-right">
                                <b class="${bal >= 0 ? 'text-red-500' : 'text-green-500'} text-lg">₹${Math.abs(bal)}</b>
                                <div class="text-[8px] opacity-40 uppercase">${bal >= 0 ? 'Give' : 'Get'}</div>
                            </div>
                            <button onclick="event.stopPropagation(); openCustomerModal(${c.id})" class="p-2 text-blue-500"><i class="fa-solid fa-pen"></i></button>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
        }

        function renderDetails() {
            const cust = db.customers.find(c => c.id === activeCid);
            document.getElementById('backBtn').classList.remove('hidden');
            document.getElementById('pageTitle').innerText = cust.name;
            
            let rawTrans = db.trans.filter(t => t.cid === activeCid).sort((a,b) => new Date(a.date) - new Date(b.date));
            let tGive = 0, tGot = 0;
            rawTrans.forEach(t => t.type === 'GAVE' ? tGive += t.amt : tGot += t.amt);

            let runningBal = 0;
            let displayList = [];
            rawTrans.forEach(t => {
                runningBal += (t.type === 'GAVE' ? t.amt : -t.amt);
                displayList.unshift({ ...t, currentBal: Math.abs(runningBal) });
            });

            document.getElementById('mainContent').innerHTML = `
                <div class="dashboard-card" style="padding: 30px 20px;">
                    <div class="balance-amount" style="font-size: 40px; margin-bottom: 20px;">₹${Math.abs(tGive - tGot)}</div>
                    <div class="flex justify-center gap-3">
                        <button class="bg-white/20 px-6 py-3 rounded-2xl font-bold text-xs" onclick="openPrintModal()">REPORT</button>
                        <button class="bg-white text-blue-600 px-6 py-3 rounded-2xl font-bold text-xs" onclick="showQR(${Math.abs(tGive - tGot)})">QR PAY</button>
                    </div>
                </div>
                <div class="list-container">
                    ${displayList.map(t => `
                        <div class="trans-card">
                            <div style="width:105px"><div class="font-bold">${fmtDate(t.date)}</div><div class="text-[10px] opacity-40 truncate">${t.remark || '-'}</div></div>
                            <div class="font-bold text-red-500 text-center">${t.type === 'GAVE' ? t.amt : '-'}</div>
                            <div class="font-bold text-green-500 text-center">${t.type === 'GOT' ? t.amt : '-'}</div>
                            <div class="font-black text-right">₹${t.currentBal}</div>
                            <button onclick="openTransModal('${t.type}', ${t.id})" class="text-blue-500 p-2"><i class="fa-solid fa-edit"></i></button>
                        </div>
                    `).join('')}
                </div>`;
            document.getElementById('footerActions').innerHTML = `<div class="footer"><button class="btn-action bg-red-600" onclick="openTransModal('GAVE')">GAVE ₹</button><button class="btn-action bg-green-600" onclick="openTransModal('GOT')">GOT ₹</button></div>`;
        }

        // Modal System
        function openModal(content) {
            const box = document.getElementById('modalBox');
            box.innerHTML = content;
            document.getElementById('modalOverlay').style.display = 'flex';
            setTimeout(() => box.classList.add('active'), 10);
        }

        function closeModal() {
            document.getElementById('modalBox').classList.remove('active');
            setTimeout(() => document.getElementById('modalOverlay').style.display = 'none', 300);
        }

        document.getElementById('modalOverlay').addEventListener('click', closeModal);
        document.getElementById('modalBox').addEventListener('click', e => e.stopPropagation());

        // Features
        function openCustomerModal(id = null) {
            const c = id ? db.customers.find(x => x.id === id) : { name: '', phone: '' };
            openModal(`
                <h2 class="text-lg font-black mb-8 text-center uppercase">Customer Details</h2>
                <div class="input-group"><label class="input-label">Name</label><input type="text" id="cName" class="input-field" value="${c.name}"></div>
                <div class="input-group"><label class="input-label">WhatsApp (91...)</label><input type="number" id="cPhone" class="input-field" value="${c.phone || ''}"></div>
                <div class="flex gap-4 mt-6">
                    <button class="flex-1 py-4 font-bold opacity-50" onclick="closeModal()">BACK</button>
                    <button class="flex-[2] py-4 bg-blue-600 text-white rounded-2xl font-bold" onclick="saveCustomer(${id})">SAVE</button>
                </div>
                ${id ? `<button onclick="deleteCust(${id})" class="w-full mt-8 text-red-500 text-xs font-bold uppercase">Delete Customer</button>` : ''}
            `);
        }

        function saveCustomer(id) {
            const name = document.getElementById('cName').value.trim();
            const phone = document.getElementById('cPhone').value.trim();
            if(!name) return alert("Enter Name");
            if(id) { let x = db.customers.find(y => y.id === id); x.name = name; x.phone = phone; }
            else { db.customers.push({ id: Date.now(), name, phone }); }
            saveDB(); closeModal();
        }

        function openTransModal(type, id = null) {
            const t = id ? db.trans.find(x => x.id === id) : { amt: '', remark: '', date: new Date().toISOString().split('T')[0] };
            const color = type === 'GAVE' ? '#ef4444' : '#22c55e';
            openModal(`
                <h2 class="text-lg font-black mb-6 text-center" style="color:${color}">${type} ENTRY</h2>
                <div class="input-group"><label class="input-label">Amount</label><input type="number" id="tAmt" class="input-field text-4xl text-center" value="${t.amt}" autofocus></div>
                <div class="input-group"><label class="input-label">Remark</label><input type="text" id="tRemark" class="input-field" value="${t.remark}"></div>
                <div class="input-group"><label class="input-label">Date</label><input type="date" id="tDate" class="input-field" value="${t.date}"></div>
                <div class="flex gap-4 mt-6">
                    ${id ? `<button class="flex-1 text-red-500 font-bold" onclick="deleteTrans(${id})">DELETE</button>` : `<button class="flex-1 font-bold opacity-50" onclick="closeModal()">BACK</button>`}
                    <button class="flex-[2] py-4 text-white rounded-2xl font-bold" style="background:${color}" onclick="saveTrans('${type}', ${id})">SAVE</button>
                </div>
            `);
        }

        function saveTrans(type, id) {
            const amt = parseFloat(document.getElementById('tAmt').value);
            const date = document.getElementById('tDate').value;
            const remark = document.getElementById('tRemark').value;
            if(!amt) return;
            if(id) { let x = db.trans.find(y => y.id === id); x.amt = amt; x.date = date; x.remark = remark; }
            else { db.trans.push({ id: Date.now(), cid: activeCid, type, amt, date, remark }); }
            
            saveDB();
            let c = db.customers.find(x => x.id === activeCid);
            let bal = 0; db.trans.filter(t => t.cid === activeCid).forEach(t => bal += (t.type === 'GAVE' ? t.amt : -t.amt));
            
            openModal(`
                <div class="text-center">
                    <div class="text-5xl mb-4">✅</div>
                    <h2 class="text-xl font-bold mb-6">Entry Saved!</h2>
                    <button class="w-full py-5 bg-green-600 text-white rounded-2xl font-bold mb-4" onclick="shareWA('${c.phone}', '${type}', ${amt}, ${Math.abs(bal)})">WHATSAPP NOTIFY</button>
                    <button class="w-full py-4 opacity-50 font-bold" onclick="closeModal()">DONE</button>
                </div>
            `);
        }

        function shareWA(phone, type, amt, bal) {
            if(!phone) return alert("No Phone Number!");
            const msg = `*KHATA PRO RECEIPT*%0A*Type:* ${type}%0A*Amount:* ₹${amt}%0A*Balance:* ₹${bal}`;
            window.location.href = `https://wa.me/${phone}?text=${msg}`;
        }

        function viewCust(id) { activeCid = id; render(); }
        function goHome() { activeCid = null; render(); }
        function deleteCust(id) { if(confirm("Delete Customer?")) { db.customers = db.customers.filter(c => c.id !== id); db.trans = db.trans.filter(t => t.cid !== id); saveDB(); closeModal(); } }
        function deleteTrans(id) { if(confirm("Delete Entry?")) { db.trans = db.trans.filter(x => x.id !== id); saveDB(); closeModal(); } }

        function showQR(amt) {
            const upi = `upi://pay?pa=abdulsaleemkp563-3@okhdfcbank&am=${amt}&cu=INR`;
            openModal(`<div class="text-center"><h2 class="text-lg font-bold mb-6">Pay ₹${amt}</h2><img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upi)}" class="mx-auto rounded-xl mb-8"><button class="w-full py-4 bg-gray-200 dark:bg-gray-800 rounded-2xl" onclick="closeModal()">CLOSE</button></div>`);
        }

        function openBackup() {
            openModal(`<h2 class="text-lg font-black mb-8 text-center">Cloud Backup</h2><button class="w-full p-5 bg-green-600 text-white rounded-2xl font-bold mb-4" onclick="exportJSON()">SAVE TO FILE</button><button class="w-full p-5 bg-blue-600 text-white rounded-2xl font-bold" onclick="document.getElementById('fInp').click()">RESTORE FILE</button><input type="file" id="fInp" class="hidden" onchange="importJSON(event)">`);
        }
        function exportJSON() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(db)], {type: 'application/json'})); a.download = `khata_backup.json`; a.click(); }
        function importJSON(e) { const r = new FileReader(); r.onload = (ev) => { db = JSON.parse(ev.target.result); saveDB(); alert("Restored!"); closeModal(); }; r.readAsText(e.target.files[0]); }

        function openPrintModal() {
            const start = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            const end = new Date().toISOString().split('T')[0];
            openModal(`
                <h2 class="text-lg font-black mb-8 text-center uppercase">Print Report</h2>
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <div class="input-group"><label class="input-label">From</label><input type="date" id="pStart" class="input-field" value="${start}"></div>
                    <div class="input-group"><label class="input-label">To</label><input type="date" id="pEnd" class="input-field" value="${end}"></div>
                </div>
                <button class="w-full py-5 bg-blue-600 text-white rounded-2xl font-black" onclick="generateReport()">PREVIEW A4</button>
            `);
        }

        function generateReport() {
            const s = document.getElementById('pStart').value, e = document.getElementById('pEnd').value;
            const c = db.customers.find(x => x.id === activeCid);
            let filtered = db.trans.filter(t => t.cid === activeCid && t.date >= s && t.date <= e).sort((a,b) => new Date(a.date) - new Date(b.date));
            let html = "", b = 0;
            filtered.forEach(t => { b += (t.type === 'GAVE' ? t.amt : -t.amt); html += `<tr style="border-bottom: 1px solid #eee;"><td>${fmtDate(t.date)}</td><td>${t.remark || '-'}</td><td>${t.type === 'GAVE' ? t.amt : '-'}</td><td>${t.type === 'GOT' ? t.amt : '-'}</td><td>₹${Math.abs(b)}</td></tr>`; });
            document.getElementById('pBody').innerHTML = html;
            document.getElementById('pCustName').innerText = c.name;
            document.getElementById('pPhone').innerText = "Mob: " + (c.phone || 'N/A');
            document.getElementById('pDateLabel').innerText = `Period: ${fmtDate(s)} - ${fmtDate(e)}`;
            window.print();
        }

        window.onload = () => { applyTheme(); render(); };
    </script>
</body>
</html>