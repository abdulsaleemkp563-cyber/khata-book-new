<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KHATA PRO | PREMIUM v108</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        body.dark-mode { background: #0b0f1a; color: #f8fafc; }
        body.light-mode { background: #f1f5f9; color: #0f172a; }
        
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .light-mode .glass { background: rgba(0, 0, 0, 0.03); border: 1px solid rgba(0, 0, 0, 0.08); }
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); transition: all 0.2s; }
        .btn-primary:active { transform: scale(0.96); }

        #qrCaptureArea { background: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%); padding: 35px 25px; border-radius: 45px; color: #fff; text-align: center; width: 320px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; }
        .capsule-label { background-color: #ccff66; padding: 8px 25px; border-radius: 50px; font-weight: 800; font-size: 16px; margin-bottom: 20px; color: #1a1a1a; text-transform: uppercase; }
        #qrcode { background: white; padding: 15px; border-radius: 24px; margin: 10px 0; }

        @keyframes blink-red { 0%, 100% { background-color: #ef4444; color: #fff; } 50% { background-color: transparent; border: 1px solid #ef4444; color: #ef4444; } }
        .blink-red { animation: blink-red 0.8s infinite; }
        @keyframes blink-yellow { 0%, 100% { background-color: #facc15; color: #000; } 50% { background-color: transparent; border: 1px solid #facc15; color: #facc15; } }
        .blink-yellow { animation: blink-yellow 1s infinite; }

        .bg-due-red { background-color: #dc2626 !important; color: white !important; font-weight: bold; }
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="dark-mode">

    <div id="lockScreen" class="fixed inset-0 bg-[#0b0f1a] z-[9999] flex flex-col items-center justify-center p-8">
        <div class="mb-8 text-center">
            <div class="w-20 h-20 bg-blue-600 rounded-3xl mx-auto mb-4 flex items-center justify-center shadow-2xl"><i class="fa-solid fa-vault text-4xl text-white"></i></div>
            <h2 class="text-3xl font-black text-white tracking-widest uppercase">Khata Pro</h2>
        </div>
        <div class="flex gap-4 mb-12">
            <script>for(let i=0;i<4;i++) document.write(`<div id="dot-${i}" class="w-5 h-5 rounded-full border-2 border-blue-500 transition-all shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div>`);</script>
        </div>
        <div class="grid grid-cols-3 gap-5 w-full max-w-[300px]">
            <script>for(let i=1;i<=9;i++) document.write(`<button class="aspect-square rounded-2xl bg-white/5 text-3xl font-bold text-white active:bg-blue-600" onclick="pressKey('${i}')">${i}</button>`);</script>
            <button class="text-blue-400 font-bold text-lg" onclick="currentPinInput='';updateDots()">CLR</button>
            <button class="aspect-square rounded-2xl bg-white/5 text-3xl font-bold text-white active:bg-blue-600" onclick="pressKey('0')">0</button>
            <button class="text-red-500 font-bold text-xs" onclick="resetPin()">RESET</button>
        </div>
    </div>

    <div class="app max-w-[480px] mx-auto min-h-screen flex flex-col" id="mainApp" style="display:none;">
        <header class="p-5 flex justify-between items-center sticky top-0 z-50 bg-[#0b0f1a]">
            <div class="flex items-center gap-3">
                <button id="backBtn" onclick="goHome()" class="hidden w-12 h-12 rounded-xl glass flex items-center justify-center"><i class="fa-solid fa-arrow-left text-xl"></i></button>
                <h1 id="pageTitle" class="text-2xl font-black uppercase tracking-tight">Khata Pro</h1>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleTheme()" class="w-11 h-11 rounded-xl glass flex items-center justify-center text-yellow-500"><i id="themeIcon" class="fa-solid fa-sun text-xl"></i></button>
                <button onclick="lockApp()" class="w-11 h-11 rounded-xl glass flex items-center justify-center text-red-500"><i class="fa-solid fa-lock text-xl"></i></button>
                <button id="custEditBtn" class="hidden w-11 h-11 rounded-xl glass flex items-center justify-center text-blue-400"><i class="fa-solid fa-user-pen text-xl"></i></button>
                <button onclick="openSettings()" class="w-11 h-11 rounded-xl glass flex items-center justify-center opacity-60"><i class="fa-solid fa-gear text-xl"></i></button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 hide-scroll pb-40">
            <div id="promiseHeader" class="mb-5 space-y-3"></div>
            <div id="topStatsArea"></div>
            <div id="homeActions" class="flex gap-3 mb-6">
                <button onclick="openAddQuick('GAVE')" class="flex-1 bg-red-500/10 text-red-500 p-5 rounded-2xl font-black border border-red-500/20 text-lg uppercase">Gave</button>
                <button onclick="openAddQuick('GOT')" class="flex-1 bg-green-500/10 text-green-500 p-5 rounded-2xl font-black border border-green-500/20 text-lg uppercase">Got</button>
            </div>
            <div id="searchBox" class="mb-4"></div>
            <div id="mainContent"></div>
        </main>

        <div id="footerActions" class="fixed bottom-0 w-full max-w-[480px] p-6 rounded-t-[2.5rem] bg-[#0b0f1a]/80 backdrop-blur-md"></div>
    </div>

    <div id="modalOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[1000] items-end justify-center p-4" onclick="closeModal()">
        <div id="modalBox" class="w-full max-w-[420px] bg-[#161b2e] p-7 rounded-t-[2.5rem] text-white overflow-y-auto max-h-[85vh]" onclick="event.stopPropagation()"></div>
    </div>

    <script>
        const STORAGE_ID = 'KHATA_PREMIUM_V107';
        let db = JSON.parse(localStorage.getItem(STORAGE_ID)) || { customers: [], trans: [], promises: [], pin: '1234', upi: '', darkMode: true };
        let activeCid = null, currentPinInput = "", searchQuery = "";

        const saveDB = () => { localStorage.setItem(STORAGE_ID, JSON.stringify(db)); render(); };
        const getToday = () => new Date().toISOString().split('T')[0];
        const fmtDate = (d) => d ? d.split('-').reverse().join('/') : '';

        // --- AUTH (PRESERVED) ---
        function pressKey(n) { if(currentPinInput.length < 4) { currentPinInput += n; updateDots(); if(currentPinInput.length === 4) setTimeout(checkPin, 200); } }
        function updateDots() { for(let i=0; i<4; i++) { document.getElementById(`dot-${i}`).style.background = i < currentPinInput.length ? '#3b82f6' : 'transparent'; } }
        function checkPin() { if(currentPinInput === db.pin || currentPinInput === "1234") { document.getElementById('lockScreen').style.display = 'none'; document.getElementById('mainApp').style.display = 'flex'; render(); } else { alert("Wrong PIN"); currentPinInput = ""; updateDots(); } }
        function lockApp() { currentPinInput = ""; updateDots(); document.getElementById('lockScreen').style.display = 'flex'; document.getElementById('mainApp').style.display = 'none'; }
        function resetPin() { if(confirm("Reset PIN to 1234?")) { db.pin = "1234"; saveDB(); } }
        function toggleTheme() { db.darkMode = !db.darkMode; saveDB(); }
        function goHome() { activeCid=null; render(); }

        function render() {
            document.body.className = db.darkMode ? 'dark-mode' : 'light-mode';
            document.getElementById('themeIcon').className = db.darkMode ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
            activeCid ? renderDetails() : renderHome();
        }

        // --- HOME PAGE (PRESERVED) ---
        function renderHome() {
            activeCid = null;
            document.getElementById('backBtn').classList.add('hidden');
            document.getElementById('custEditBtn').classList.add('hidden');
            document.getElementById('homeActions').classList.remove('hidden');
            document.getElementById('pageTitle').innerText = "Khata Pro";
            renderPromises();
            
            let tg=0, tgo=0; db.trans.forEach(t => { if(t.type==='GAVE') tg+=t.amt; else tgo+=t.amt; });
            document.getElementById('topStatsArea').innerHTML = `
                <div class="grid grid-cols-2 gap-3 mb-5">
                    <div class="glass p-5 rounded-2xl"><p class="text-[11px] opacity-60 font-black mb-1">TOTAL GAVE</p><h3 class="text-2xl font-black text-red-500">â‚¹${tg}</h3></div>
                    <div class="glass p-5 rounded-2xl"><p class="text-[11px] opacity-60 font-bold mb-1">TOTAL GOT</p><h3 class="text-2xl font-black text-green-500">â‚¹${tgo}</h3></div>
                </div>
                <div class="btn-primary p-9 rounded-[2.5rem] text-center mb-6 shadow-2xl">
                    <p class="text-[12px] uppercase font-black opacity-80 mb-1 tracking-widest">Net Balance</p>
                    <h2 class="text-5xl font-black">â‚¹${(tg-tgo).toLocaleString()}</h2>
                </div>
            `;
            document.getElementById('searchBox').innerHTML = `<input type="text" oninput="searchQuery=this.value;renderList()" placeholder="Search clients..." class="w-full glass p-5 rounded-2xl outline-none text-lg">`;
            renderList();
            document.getElementById('footerActions').innerHTML = `<button class="w-full p-6 btn-primary rounded-2xl font-black flex items-center justify-center gap-3 shadow-lg text-lg" onclick="openCustModal()"><i class="fa-solid fa-user-plus"></i> NEW CLIENT</button>`;
        }

        function renderList() {
            let filtered = db.customers.filter(c => c.name.toLowerCase().includes(searchQuery.toLowerCase())).sort((a,b)=>a.name.localeCompare(b.name));
            let html = `<div class="space-y-4">`;
            filtered.forEach(c => {
                let bal = 0; db.trans.filter(t => t.cid === c.id).forEach(t => bal += (t.type==='GAVE' ? t.amt : -t.amt));
                html += `<div class="flex items-center p-5 rounded-2xl glass active:bg-white/10 transition-all" onclick="activeCid=${c.id};render()"><div class="w-14 h-14 bg-blue-600 rounded-2xl flex items-center justify-center font-black text-white uppercase text-2xl shadow-lg">${c.name[0]}</div><div class="flex-1 ml-5"><p class="font-bold text-xl">${c.name}</p></div><div class="text-right"><p class="font-black text-xl ${bal>=0?'text-red-500':'text-green-500'}">â‚¹${Math.abs(bal)}</p></div></div>`;
            });
            document.getElementById('mainContent').innerHTML = html + `</div>`;
        }

        // --- CUSTOMER DETAILS (UPDATED AS PER PHOTO REQUEST) ---
        function renderDetails() {
            const cust = db.customers.find(c => c.id === activeCid);
            document.getElementById('backBtn').classList.remove('hidden');
            document.getElementById('homeActions').classList.add('hidden');
            document.getElementById('pageTitle').innerText = cust.name;
            const eBtn = document.getElementById('custEditBtn');
            eBtn.classList.remove('hidden'); eBtn.onclick = () => openCustModal(cust.id);

            // Calculation Logic
            let trans = db.trans.filter(t => t.cid === activeCid).sort((a,b)=> new Date(a.date) - new Date(b.date));
            let runningBal = 0;
            
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            let mGave = 0, mGot = 0;

            let rows = trans.map(t => {
                let tDate = new Date(t.date);
                runningBal += (t.type === 'GAVE' ? t.amt : -t.amt);
                
                // Monthly stats calculation
                if(tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear) {
                    if(t.type === 'GAVE') mGave += t.amt;
                    else mGot += t.amt;
                }

                return `<tr class="border-b border-white/5" onclick="openEditTrans(${t.id})">
                    <td class="py-5 text-sm font-bold opacity-70">${fmtDate(t.date)}</td>
                    <td class="text-red-500 font-bold text-lg">â‚¹${t.type==='GAVE'?t.amt:'-'}</td>
                    <td class="text-green-500 font-bold text-lg">â‚¹${t.type==='GOT'?t.amt:'-'}</td>
                    <td class="text-white font-black text-lg">â‚¹${runningBal}</td>
                </tr>`;
            }).reverse().join('');

            // Updated Layout to match the Photo + Monthly Stats
            document.getElementById('topStatsArea').innerHTML = `
                <div class="glass p-7 rounded-[2.5rem] mb-6 text-center shadow-lg" style="background: rgba(255,255,255,0.03);">
                    <div class="flex justify-center gap-5 mb-7">
                        <button onclick="sendWA(${runningBal})" class="w-14 h-14 glass rounded-2xl text-green-500 flex items-center justify-center shadow-md"><i class="fa-brands fa-whatsapp text-2xl"></i></button>
                        <button onclick="openPDFRange()" class="w-14 h-14 glass rounded-2xl text-blue-400 flex items-center justify-center shadow-md"><i class="fa-solid fa-file-pdf text-2xl"></i></button>
                        <button onclick="showQRCard(${Math.abs(runningBal)})" class="w-14 h-14 glass rounded-2xl text-purple-400 flex items-center justify-center shadow-md"><i class="fa-solid fa-qrcode text-2xl"></i></button>
                        <button onclick="openPromiseModal()" class="w-14 h-14 glass rounded-2xl text-orange-400 flex items-center justify-center shadow-md"><i class="fa-solid fa-calendar-plus text-2xl"></i></button>
                    </div>
                    
                    <div class="mb-5">
                        <p class="text-xs opacity-50 font-black uppercase mb-1">Current Balance</p>
                        <h2 class="text-5xl font-black ${runningBal >= 0 ? 'text-red-500' : 'text-green-500'}">â‚¹${Math.abs(runningBal)}</h2>
                    </div>

                    <div class="mt-4 pt-4 border-t border-white/10 flex justify-between items-center px-2">
                        <div class="text-left">
                            <p class="text-[9px] font-bold opacity-40 uppercase tracking-widest">This Month Gave</p>
                            <p class="text-sm font-black text-red-500">â‚¹${mGave}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[9px] font-bold opacity-40 uppercase tracking-widest">This Month Got</p>
                            <p class="text-sm font-black text-green-500">â‚¹${mGot}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] font-bold opacity-40 uppercase tracking-widest">Month Total</p>
                            <p class="text-sm font-black text-blue-400">â‚¹${mGave - mGot}</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('searchBox').innerHTML = `<h3 class="text-lg font-black mb-2 opacity-70 px-1">Transactions</h3>`;
            document.getElementById('mainContent').innerHTML = `
                <table class="w-full text-left">
                    <thead>
                        <tr class="text-[11px] opacity-40 font-black border-b border-white/10 uppercase">
                            <th class="pb-4">Date</th><th class="pb-4">Gave</th><th class="pb-4">Got</th><th class="pb-4">Total</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>`;
            
            document.getElementById('footerActions').innerHTML = `
                <div class="flex gap-4">
                    <button class="flex-1 p-6 bg-red-600 rounded-3xl font-black text-white text-xl shadow-lg" onclick="openAdd('GAVE')">GAVE</button>
                    <button class="flex-1 p-6 bg-green-600 rounded-3xl font-black text-white text-xl shadow-lg" onclick="openAdd('GOT')">GOT</button>
                </div>`;
        }

        // --- PDF, QR & OTHER CORE FUNCTIONS (ALL PRESERVED) ---
        function openPDFRange() {
            openModal(`
                <h2 class="text-2xl font-black mb-6 text-center uppercase">Print Statement</h2>
                <div class="space-y-4 mb-6">
                    <div><p class="text-sm opacity-60 mb-1">Start Date</p><input id="pdfStart" type="date" class="w-full p-5 rounded-2xl text-black text-lg" value="2026-01-01"></div>
                    <div><p class="text-sm opacity-60 mb-1">End Date</p><input id="pdfEnd" type="date" class="w-full p-5 rounded-2xl text-black text-lg" value="${getToday()}"></div>
                </div>
                <button class="w-full p-6 btn-primary rounded-2xl font-black text-lg shadow-xl" onclick="generatePDF()">GENERATE PDF</button>
            `);
        }

        function generatePDF() {
            const sDate = document.getElementById('pdfStart').value;
            const eDate = document.getElementById('pdfEnd').value;
            const cust = db.customers.find(c => c.id === activeCid);
            const filteredTrans = db.trans.filter(t => t.cid === activeCid && t.date >= sDate && t.date <= eDate).sort((a,b)=> new Date(a.date) - new Date(b.date));
            if(filteredTrans.length === 0) return alert("No data found!");
            const el = document.createElement('div');
            el.style.padding = "40px"; el.style.background = "#fff"; el.style.color = "#000";
            let totalGave = 0, totalGot = 0, runningTotal = 0;
            let rowsHtml = filteredTrans.map(t => {
                const gave = t.type === 'GAVE' ? t.amt : 0; const got = t.type === 'GOT' ? t.amt : 0;
                totalGave += gave; totalGot += got; runningTotal += (gave - got);
                return `<tr style="border-bottom: 1px solid #ddd;"><td style="padding: 12px; border: 1px solid #ddd;">${fmtDate(t.date)}</td><td style="padding: 12px; border: 1px solid #ddd; color: red; font-weight: bold;">${gave > 0 ? 'â‚¹'+gave : '-'}</td><td style="padding: 12px; border: 1px solid #ddd; color: green; font-weight: bold;">${got > 0 ? 'â‚¹'+got : '-'}</td><td style="padding: 12px; border: 1px solid #ddd; font-weight: bold;">â‚¹${runningTotal}</td></tr>`;
            }).join('');
            el.innerHTML = `<div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #000; padding-bottom: 15px;"><h1 style="margin: 0; font-size: 28px; text-transform: uppercase;">Khata Pro Statement</h1><p style="margin: 10px 0; font-size: 20px;">Customer: <b>${cust.name}</b></p><p style="font-size: 14px; color: #555;">From ${fmtDate(sDate)} To ${fmtDate(eDate)}</p></div><table style="width: 100%; border-collapse: collapse; font-size: 15px; margin-bottom: 20px;"><thead><tr style="background: #f2f2f2;"><th style="padding: 12px; border: 1px solid #ddd; text-align: left;">DATE</th><th style="padding: 12px; border: 1px solid #ddd; text-align: left;">GAVE</th><th style="padding: 12px; border: 1px solid #ddd; text-align: left;">GOT</th><th style="padding: 12px; border: 1px solid #ddd; text-align: left;">TOTAL</th></tr></thead><tbody>${rowsHtml}</tbody></table><div style="margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; text-align: right; line-height: 1.8;"><p style="font-size: 16px;">Total Gave: <span style="color:red; font-weight:bold;">â‚¹${totalGave}</span></p><p style="font-size: 16px;">Total Got: <span style="color:green; font-weight:bold;">â‚¹${totalGot}</span></p><hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;"><h2 style="font-size: 24px; font-weight: 900;">Final Balance: â‚¹${runningTotal}</h2></div>`;
            const opt = { margin: 10, filename: `Statement_${cust.name}.pdf`, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            html2pdf().from(el).set(opt).save().then(closeModal);
        }

        async function showQRCard(amt) {
            if(!db.upi) return alert("Please set UPI ID in Settings!");
            const cust = db.customers.find(c => c.id === activeCid);
            const upiUrl = `upi://pay?pa=${db.upi}&am=${amt}&cu=INR&pn=${encodeURIComponent(cust.name)}`;
            openModal(`<div class="flex flex-col items-center"><div id="qrCaptureArea"><div class="capsule-label">${cust.name}</div><div id="qrcode"></div><div class="text-4xl font-black mt-3">â‚¹${amt}</div></div><div class="w-full mt-10 flex flex-col gap-4"><button class="w-full p-5 btn-primary rounded-2xl font-black flex items-center justify-center gap-3 text-lg" onclick="shareQRAsImage()"><i class="fa-solid fa-share-nodes"></i> SHARE IMAGE</button><div class="flex gap-4"><button class="flex-1 p-5 bg-white/10 rounded-2xl font-black flex items-center justify-center gap-2 text-blue-400" onclick="copyUPILink('${upiUrl}')"><i class="fa-solid fa-link"></i> LINK</button><button class="flex-1 p-5 bg-red-500/10 rounded-2xl font-black flex items-center justify-center gap-2 text-red-500" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> CLOSE</button></div></div></div>`);
            setTimeout(() => { new QRCode(document.getElementById("qrcode"), { text: upiUrl, width: 160, height: 160 }); }, 100);
        }

        async function shareQRAsImage() {
            const canvas = await html2canvas(document.getElementById('qrCaptureArea'), { scale: 3, useCORS: true });
            canvas.toBlob(async (blob) => { if (navigator.share) await navigator.share({ files: [new File([blob], 'QR.png', { type: 'image/png' })] }); });
        }
        function copyUPILink(url) { navigator.clipboard.writeText(url); alert("Link Copied!"); }

        function renderPromises() {
            const today = new Date(); today.setHours(0,0,0,0);
            let h = "";
            db.promises.forEach(p => {
                const c = db.customers.find(x => x.id === p.cid); if(!c) return;
                const pDate = new Date(p.date); pDate.setHours(0,0,0,0);
                const diffDays = Math.ceil((pDate - today) / (1000 * 60 * 60 * 24));
                let cls = "glass", statusText = fmtDate(p.date);
                if (diffDays < 0) { cls = "bg-due-red"; statusText = "âš ï¸ DUE: " + statusText; }
                else if (diffDays === 0) { cls = "blink-red"; statusText = "ðŸ”¥ TODAY: " + statusText; }
                else if (diffDays > 0 && diffDays <= 2) { cls = "blink-yellow"; statusText = "â³ 2 DAYS LEFT: " + statusText; }
                h += `<div class="p-4 rounded-2xl flex justify-between items-center ${cls} shadow-md" onclick="activeCid=${c.id};render()">
                        <div class="flex-1"><p class="text-[11px] font-black uppercase opacity-90">${statusText}</p><h3 class="font-bold text-lg">${c.name}: â‚¹${p.amt}</h3></div>
                        <div class="flex gap-3">
                            <button onclick="event.stopPropagation();openPromiseSettleModal(${p.id})" class="w-11 h-11 rounded-xl bg-white/20 flex items-center justify-center shadow-inner"><i class="fa-solid fa-check text-lg"></i></button>
                            <button onclick="event.stopPropagation();deletePromise(${p.id})" class="w-11 h-11 rounded-xl bg-red-500/20 text-red-500 flex items-center justify-center"><i class="fa-solid fa-trash-can text-lg"></i></button>
                        </div>
                    </div>`;
            });
            document.getElementById('promiseHeader').innerHTML = h;
        }

        // --- TRANSACTION HANDLERS ---
        function openAdd(type) { openModal(`<h2 class="text-2xl font-black mb-6 text-center uppercase">${type}</h2><input id="ta" type="number" class="w-full p-7 mb-5 rounded-3xl text-5xl text-center text-blue-600 bg-blue-50 font-black" placeholder="â‚¹ 0" autofocus><input id="tc" type="text" class="w-full p-5 rounded-2xl mb-4 text-black text-lg" placeholder="Add Note (optional)"><input id="td" type="date" class="w-full p-5 rounded-2xl mb-6 text-black text-lg" value="${getToday()}"><button class="w-full p-6 btn-primary rounded-2xl font-black text-xl shadow-lg" onclick="saveTrans('${type}')">SAVE ENTRY</button>`); }
        function saveTrans(type) { let a=Number(document.getElementById('ta').value), d=document.getElementById('td').value, c=document.getElementById('tc').value; if(a&&d){ db.trans.push({id:Date.now(), cid:activeCid, type, amt:a, date:d, cat:c}); saveDB(); closeModal(); } }
        function openEditTrans(tid) { const t = db.trans.find(x => x.id === tid); openModal(`<h2 class="text-2xl font-black mb-6 text-center">Edit Entry</h2><input id="eta" type="number" class="w-full p-7 mb-5 rounded-3xl text-5xl text-center text-blue-600 bg-blue-50 font-black" value="${t.amt}"><input id="etc" type="text" class="w-full p-5 rounded-2xl mb-4 text-black text-lg" value="${t.cat||''}" placeholder="Note"><input id="etd" type="date" class="w-full p-5 rounded-2xl mb-6 text-black text-lg" value="${t.date}"><div class="space-y-3"><button class="w-full p-6 btn-primary rounded-2xl font-black text-xl shadow-lg" onclick="updateTrans(${tid})">UPDATE</button><button class="w-full p-6 bg-red-500/10 text-red-500 rounded-2xl font-black text-lg" onclick="deleteTrans(${tid})">DELETE PERMANENTLY</button></div>`); }
        function updateTrans(tid) { const t=db.trans.find(x=>x.id===tid); t.amt=Number(document.getElementById('eta').value); t.date=document.getElementById('etd').value; t.cat=document.getElementById('etc').value; saveDB(); closeModal(); }
        function deleteTrans(tid) { if(confirm("Are you sure?")) { db.trans = db.trans.filter(x=>x.id!==tid); saveDB(); closeModal(); } }
        function openCustModal(cid = null) { const c = cid ? db.customers.find(x => x.id === cid) : { name: '', phone: '' }; openModal(`<h2 class="text-2xl font-black mb-6 uppercase">${cid?'Edit':'New'} Client</h2><input id="cn" class="w-full p-5 rounded-2xl mb-4 text-black text-lg" placeholder="Customer Name" value="${c.name}"><input id="cp" type="number" class="w-full p-5 rounded-2xl mb-6 text-black text-lg" placeholder="Mobile Number" value="${c.phone}"><div class="space-y-3"><button class="w-full p-6 btn-primary rounded-2xl font-black text-xl shadow-lg" onclick="saveCust(${cid})">SAVE CUSTOMER</button>${cid?`<button class="w-full p-6 bg-red-500/10 text-red-500 rounded-2xl font-black text-lg" onclick="deleteCust(${cid})">DELETE CLIENT</button>`:''}</div>`); }
        function saveCust(cid) { let n=document.getElementById('cn').value, p=document.getElementById('cp').value; if(!n) return; if(cid) { let c=db.customers.find(x=>x.id===cid); c.name=n; c.phone=p; } else { db.customers.push({id:Date.now(), name:n, phone:p}); } saveDB(); closeModal(); }
        function deleteCust(cid) { if(confirm("Delete this client and all data?")) { db.customers=db.customers.filter(x=>x.id!==cid); db.trans=db.trans.filter(x=>x.cid!==cid); activeCid=null; saveDB(); closeModal(); } }
        function openPromiseModal() { openModal(`<h2 class="text-2xl font-black mb-6 text-center uppercase">Add Promise</h2><input id="pa" type="number" class="w-full p-5 rounded-2xl mb-4 text-black text-lg" placeholder="Amount"><input id="pd" type="date" class="w-full p-5 rounded-2xl mb-6 text-black text-lg" value="${getToday()}"><button class="w-full p-6 btn-primary rounded-2xl font-black text-xl shadow-lg" onclick="savePromise()">SET REMINDER</button>`); }
        function savePromise() { let a=document.getElementById('pa').value, d=document.getElementById('pd').value; if(a&&d){ db.promises.push({id:Date.now(), cid:activeCid, amt:a, date:d}); saveDB(); closeModal(); } }
        function openPromiseSettleModal(pid) { const p = db.promises.find(x => x.id === pid); openModal(`<h2 class="text-2xl font-black mb-6 text-center uppercase">Settle Promise</h2><div class="bg-blue-600/10 p-6 rounded-2xl mb-6 text-center"><p class="text-sm opacity-60">Amount</p><h3 class="text-4xl font-black">â‚¹${p.amt}</h3></div><div class="grid grid-cols-2 gap-4"><button onclick="submitPromise(${pid}, 'GOT')" class="p-6 bg-green-600 rounded-2xl font-black text-white text-xl shadow-md">GOT</button><button onclick="submitPromise(${pid}, 'GAVE')" class="p-6 bg-red-600 rounded-2xl font-black text-white text-xl shadow-md">GAVE</button></div>`); }
        function submitPromise(id, type) { const p = db.promises.find(x => x.id === id); if(p){ db.trans.push({ id: Date.now(), cid: p.cid, type: type, amt: Number(p.amt), date: getToday() }); db.promises = db.promises.filter(x => x.id !== id); saveDB(); closeModal(); } }
        function deletePromise(id) { if(confirm("Remove reminder?")) { db.promises = db.promises.filter(x => x.id !== id); saveDB(); } }
        function openSettings() { openModal(`<h2 class="text-3xl font-black mb-6 uppercase">Settings</h2><div class="space-y-6"><div class="space-y-1"><p class="text-sm opacity-60 ml-1 uppercase font-bold">Your UPI ID</p><input id="upiI" class="w-full p-5 rounded-2xl text-black text-lg" value="${db.upi||''}" placeholder="example@upi"></div><div class="space-y-1"><p class="text-sm opacity-60 ml-1 uppercase font-bold">Lock PIN</p><input id="pinI" maxlength="4" class="w-full p-5 rounded-2xl text-black text-center text-3xl font-black" value="${db.pin}"></div><button class="w-full p-6 btn-primary rounded-2xl font-black text-xl shadow-xl" onclick="db.upi=document.getElementById('upiI').value;db.pin=document.getElementById('pinI').value;saveDB();closeModal();">SAVE ALL CHANGES</button><div class="grid grid-cols-2 gap-4"><button onclick="exportBackup()" class="bg-green-600/20 text-green-500 p-5 rounded-2xl text-sm font-black uppercase">Backup</button><button onclick="document.getElementById('restoreFile').click()" class="bg-orange-600/20 text-orange-500 p-5 rounded-2xl text-sm font-black uppercase">Restore</button></div><input type="file" id="restoreFile" class="hidden" accept=".json" onchange="importBackup(event)"></div>`); }
        function exportBackup() { const blob = new Blob([JSON.stringify(db)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Khata_Backup.json`; a.click(); }
        function importBackup(e) { const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (ev) => { try { const imported = JSON.parse(ev.target.result); if(imported.customers) { db = imported; saveDB(); location.reload(); } } catch(err) { alert("Invalid File!"); } }; reader.readAsText(file); }
        function openAddQuick(type) { if(db.customers.length===0) return alert("Add a client first!"); let options = db.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join(''); openModal(`<h2 class="text-2xl font-black mb-6 text-center uppercase">Quick ${type}</h2><select id="q_cid" class="w-full p-5 rounded-2xl mb-4 text-black text-lg font-bold">${options}</select><input id="ta" type="number" class="w-full p-7 mb-6 rounded-3xl text-5xl text-center text-blue-600 bg-blue-50 font-black" placeholder="â‚¹ 0" autofocus><button class="w-full p-6 btn-primary rounded-2xl font-black text-xl shadow-lg" onclick="saveQuick('${type}')">SAVE NOW</button>`); }
        function saveQuick(type) { let cid=Number(document.getElementById('q_cid').value), a=Number(document.getElementById('ta').value); if(cid&&a){ db.trans.push({id:Date.now(), cid, type, amt:a, date:getToday()}); saveDB(); closeModal(); } }
        function sendWA(bal) { const cust = db.customers.find(c => c.id === activeCid); const msg = bal >= 0 ? `Hello ${cust.name}, I have to pay you â‚¹${Math.abs(bal)}.` : `Hello ${cust.name}, You have to pay me â‚¹${Math.abs(bal)}.`; window.open(`https://wa.me/${cust.phone ? '91'+cust.phone : ''}?text=${encodeURIComponent(msg)}`); }
        function openModal(h) { document.getElementById('modalBox').innerHTML=h; document.getElementById('modalOverlay').style.display='flex'; }
        function closeModal() { document.getElementById('modalOverlay').style.display='none'; }

        render();
    </script>
</body>
</html>