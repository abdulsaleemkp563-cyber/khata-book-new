<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KHATA PRO | v65</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        body.dark-mode { background: #020617; color: #f8fafc; }
        body.light-mode { background: #f1f5f9; color: #0f172a; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .app { width: 100%; max-width: 480px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
        .content-scrollable { flex: 1; overflow-y: auto; padding-bottom: 150px; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }

        /* QR Card Fix for Sharing */
        .qr-card-container { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; }
        .qr-card-box { background: white; color: black; padding: 20px; border-radius: 20px; text-align: center; width: 300px; border: 10px solid #3b82f6; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #qrcode { display: inline-block; padding: 10px; background: white; border-radius: 10px; }
        #qrcode img { margin: 0 auto; max-width: 100%; pointer-events: auto !important; } /* Allows long press to save/share */

        @keyframes blink-yellow { 0%, 100% { background: #eab308; color: #000; } 50% { background: transparent; } }
        .p-blink-yellow { animation: blink-yellow 1s infinite; }
    </style>
</head>
<body class="dark-mode">

    <div id="lockScreen" class="fixed inset-0 bg-[#020617] z-[9999] flex flex-col items-center justify-center p-8">
        <h2 class="text-2xl font-black text-white mb-10 tracking-widest uppercase">Khata Pro</h2>
        <div class="flex gap-4 mb-12">
            <div id="dot-0" class="w-4 h-4 rounded-full border-2 border-blue-500"></div>
            <div id="dot-1" class="w-4 h-4 rounded-full border-2 border-blue-500"></div>
            <div id="dot-2" class="w-4 h-4 rounded-full border-2 border-blue-500"></div>
            <div id="dot-3" class="w-4 h-4 rounded-full border-2 border-blue-500"></div>
        </div>
        <div class="grid grid-cols-3 gap-4 w-full max-w-[280px]">
            <script>for(let i=1;i<=9;i++) document.write(`<button class="aspect-square rounded-2xl bg-white/5 text-2xl font-bold text-white active:bg-blue-600" onclick="pressKey('${i}')">${i}</button>`);</script>
            <button class="text-blue-400 font-bold" onclick="currentPinInput='';updateDots()">CLR</button>
            <button class="aspect-square rounded-2xl bg-white/5 text-2xl font-bold text-white" onclick="pressKey('0')">0</button>
            <button class="text-red-500 font-bold text-[10px]" onclick="resetPin()">RESET</button>
        </div>
    </div>

    <div class="app" id="mainApp" style="display:none;">
        <header class="p-5 flex justify-between items-center glass sticky top-0 z-50">
            <div class="flex items-center gap-3">
                <button id="backBtn" onclick="goHome()" class="hidden w-10 h-10 rounded-xl glass flex items-center justify-center"><i class="fa-solid fa-arrow-left"></i></button>
                <h1 id="pageTitle" class="text-lg font-black uppercase">Khata Pro</h1>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleTheme()" class="w-10 h-10 rounded-xl glass flex items-center justify-center text-yellow-500"><i id="themeIcon" class="fa-solid fa-sun"></i></button>
                <button onclick="lockApp()" class="w-10 h-10 rounded-xl glass flex items-center justify-center text-red-500"><i class="fa-solid fa-lock"></i></button>
                <button onclick="openSettings()" class="w-10 h-10 rounded-xl glass flex items-center justify-center opacity-60"><i class="fa-solid fa-gear"></i></button>
            </div>
        </header>

        <div class="content-scrollable p-4">
            <div id="promiseHeader" class="mb-4 space-y-3"></div>
            <div id="topStats"></div>
            <div id="homeActions" class="flex gap-2 mb-4">
                <button onclick="openAddQuick('GAVE')" class="flex-1 bg-red-600/20 text-red-500 p-4 rounded-2xl font-black border border-red-600/30">GAVE</button>
                <button onclick="openAddQuick('GOT')" class="flex-1 bg-green-600/20 text-green-500 p-4 rounded-2xl font-black border border-green-600/30">GOT</button>
            </div>
            <div id="searchBox" class="mb-4"></div>
            <div id="mainContent"></div>
        </div>
        <div id="footerActions" class="fixed bottom-0 w-full max-w-[480px] p-6 glass rounded-t-3xl"></div>
    </div>

    <div id="modalOverlay" class="fixed inset-0 bg-black/95 hidden z-[1000] items-center justify-center p-4" onclick="closeModal()">
        <div id="modalBox" class="w-full max-w-[420px] bg-[#0f172a] p-6 rounded-[2rem] text-white overflow-y-auto max-h-[90vh]" onclick="event.stopPropagation()"></div>
    </div>

    <script>
        const STORAGE_ID = 'KHATA_STABLE_V16';
        let db = JSON.parse(localStorage.getItem(STORAGE_ID)) || { customers: [], trans: [], promises: [], pin: '1234', upi: '', darkMode: true };
        let activeCid = null, currentPinInput = "", searchQuery = "";

        const saveDB = () => { localStorage.setItem(STORAGE_ID, JSON.stringify(db)); render(); };
        const getToday = () => new Date().toISOString().split('T')[0];
        const fmtDate = (d) => d ? d.split('-').reverse().join('/') : '';

        // --- AUTH ---
        function pressKey(n) { if(currentPinInput.length<4){ currentPinInput+=n; updateDots(); if(currentPinInput.length===4) setTimeout(checkPin,200); } }
        function updateDots() { for(let i=0;i<4;i++) document.getElementById(`dot-${i}`).style.background = i<currentPinInput.length?'#3b82f6':'transparent'; }
        function checkPin() { if(currentPinInput===db.pin || currentPinInput==="1234"){ document.getElementById('lockScreen').style.display='none'; document.getElementById('mainApp').style.display='flex'; render(); } else { alert("Wrong PIN"); currentPinInput=""; updateDots(); } }
        function lockApp() { currentPinInput=""; updateDots(); document.getElementById('lockScreen').style.display='flex'; document.getElementById('mainApp').style.display='none'; }
        function resetPin() { if(confirm("Reset PIN to 1234?")){ db.pin="1234"; saveDB(); currentPinInput=""; updateDots(); } }
        function toggleTheme() { db.darkMode = !db.darkMode; saveDB(); }

        // --- RENDER ---
        function render() {
            document.body.className = db.darkMode ? 'dark-mode' : 'light-mode';
            document.getElementById('themeIcon').className = db.darkMode ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
            activeCid ? renderDetails() : renderHome();
        }

        function renderHome() {
            activeCid = null; document.getElementById('backBtn').classList.add('hidden');
            document.getElementById('homeActions').style.display = 'flex';
            renderPromises();
            let tg=0, tgo=0; db.trans.forEach(t => { if(t.type==='GAVE') tg+=t.amt; else tgo+=t.amt; });
            document.getElementById('topStats').innerHTML = `<div class="btn-primary p-6 rounded-3xl text-center mb-4"><p class="text-[10px] uppercase font-bold opacity-70">Balance</p><h2 class="text-3xl font-black">₹${(tg-tgo).toLocaleString()}</h2></div>`;
            document.getElementById('searchBox').innerHTML = `<input type="text" oninput="searchQuery=this.value;renderList()" placeholder="Search..." class="w-full glass p-4 rounded-xl outline-none">`;
            renderList();
        }

        function renderPromises() {
            const todayStr = getToday(); const today = new Date(todayStr);
            let h = "";
            db.promises.forEach(p => {
                const c = db.customers.find(x => x.id === p.cid); if(!c) return;
                const diff = (new Date(p.date) - today) / 86400000;
                let style = "glass", sText = fmtDate(p.date);
                if (diff < 0) style = "bg-red-600 text-white";
                else if (diff <= 1) style = "p-blink-yellow";

                h += `<div class="p-4 rounded-2xl flex justify-between items-center ${style}" onclick="activeCid=${c.id};render()">
                    <div><p class="text-[9px] uppercase font-bold">${sText}</p><h3 class="font-black">${c.name}: ₹${p.amt}</h3></div>
                    <div class="flex gap-2">
                        <button onclick="event.stopPropagation();submitPromise(${p.id})" class="w-10 h-10 rounded-xl bg-green-500 text-white"><i class="fa-solid fa-check"></i></button>
                        <button onclick="event.stopPropagation();deletePromise(${p.id})" class="w-10 h-10 rounded-xl bg-red-800 text-white"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>`;
            });
            document.getElementById('promiseHeader').innerHTML = h;
        }

        function renderList() {
            let filtered = db.customers.filter(c => c.name.toLowerCase().includes(searchQuery.toLowerCase())).sort((a,b)=>a.name.localeCompare(b.name));
            let html = `<div class="pb-24">`;
            filtered.forEach(c => {
                let bal = 0; db.trans.filter(t => t.cid === c.id).forEach(t => bal += (t.type==='GAVE' ? t.amt : -t.amt));
                html += `<div class="flex items-center p-4 mb-3 rounded-2xl glass" onclick="activeCid=${c.id};render()">
                    <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center font-black text-white">${c.name[0]}</div>
                    <div class="flex-1 ml-4 font-bold">${c.name}</div>
                    <div class="text-right font-black ${bal>=0?'text-red-500':'text-green-500'}">₹${Math.abs(bal)}</div>
                </div>`;
            });
            document.getElementById('mainContent').innerHTML = html + `</div><button class="fixed bottom-28 right-8 w-14 h-14 btn-primary rounded-full shadow-2xl flex items-center justify-center text-white" onclick="openCustModal()"><i class="fa-solid fa-plus text-xl"></i></button>`;
        }

        function renderDetails() {
            const cust = db.customers.find(c => c.id === activeCid);
            document.getElementById('backBtn').classList.remove('hidden');
            document.getElementById('homeActions').style.display = 'none';
            document.getElementById('pageTitle').innerText = cust.name;
            let b=0, gv=0, gt=0;
            let trans = db.trans.filter(t => t.cid === activeCid).sort((a,b)=> new Date(a.date) - new Date(b.date));
            let rows = trans.map(t => {
                b += (t.type==='GAVE'?t.amt:-t.amt); if(t.type==='GAVE') gv+=t.amt; else gt+=t.amt;
                return `<tr class="border-b border-white/5"><td class="py-4 text-[10px] opacity-50">${fmtDate(t.date)}</td><td class="text-red-500 font-bold">₹${t.type==='GAVE'?t.amt:'-'}</td><td class="text-green-500 font-bold">₹${t.type==='GOT'?t.amt:'-'}</td><td class="font-black text-right">₹${b}</td></tr>`;
            }).reverse().join('');

            document.getElementById('topStats').innerHTML = `
                <div class="glass p-5 rounded-3xl flex justify-between items-center mb-4">
                    <div><p class="text-[10px] opacity-50 uppercase">Balance</p><h2 class="text-2xl font-black">₹${Math.abs(b)}</h2></div>
                    <div class="flex gap-2">
                        <button onclick="sendWA(${b})" class="w-10 h-10 glass rounded-xl text-green-500 flex items-center justify-center"><i class="fa-brands fa-whatsapp"></i></button>
                        <button onclick="openPDFRange()" class="w-10 h-10 glass rounded-xl text-blue-400 flex items-center justify-center"><i class="fa-solid fa-file-pdf"></i></button>
                        <button onclick="showQRCard(${Math.abs(b)})" class="w-10 h-10 glass rounded-xl text-purple-400 flex items-center justify-center"><i class="fa-solid fa-qrcode"></i></button>
                        <button onclick="openPromiseModal()" class="w-10 h-10 glass rounded-xl text-orange-400 flex items-center justify-center"><i class="fa-solid fa-calendar-plus"></i></button>
                    </div>
                </div>`;
            document.getElementById('mainContent').innerHTML = `<table class="w-full text-left"><thead><tr class="text-[10px] opacity-40"><th class="py-2">DATE</th><th>GAVE</th><th>GOT</th><th class="text-right">TOTAL</th></tr></thead><tbody>${rows}</tbody></table>`;
            document.getElementById('footerActions').innerHTML = `<div class="flex gap-4"><button class="flex-1 p-5 bg-red-600 rounded-2xl font-black text-white" onclick="openAdd('GAVE')">GAVE</button><button class="flex-1 p-5 bg-green-600 rounded-2xl font-black text-white" onclick="openAdd('GOT')">GOT</button></div>`;
        }

        // --- PDF START & END ---
        function openPDFRange() {
            openModal(`
                <h2 class="font-bold mb-4 text-center">PDF Report</h2>
                <div class="space-y-4">
                    <div><p class="text-[10px] mb-1 opacity-60">From Date:</p><input id="pdfStart" type="date" class="w-full p-4 rounded-xl text-black" value="2025-01-01"></div>
                    <div><p class="text-[10px] mb-1 opacity-60">To Date:</p><input id="pdfEnd" type="date" class="w-full p-4 rounded-xl text-black" value="${getToday()}"></div>
                    <button class="w-full p-5 btn-primary rounded-2xl font-black mt-4" onclick="generatePDF()">GENERATE</button>
                </div>
            `);
        }
        function generatePDF() {
            const s = document.getElementById('pdfStart').value, e = document.getElementById('pdfEnd').value;
            const cust = db.customers.find(c => c.id === activeCid);
            const el = document.createElement('div'); el.style.padding = "30px"; el.style.background = "#fff"; el.style.color = "#000";
            let trans = db.trans.filter(t => t.cid === activeCid && t.date >= s && t.date <= e).sort((a,b)=> new Date(a.date) - new Date(b.date));
            let rows = trans.map(t => `<tr><td style="border:1px solid #ddd;padding:8px">${fmtDate(t.date)}</td><td style="border:1px solid #ddd;padding:8px">${t.type==='GAVE'?t.amt:''}</td><td style="border:1px solid #ddd;padding:8px">${t.type==='GOT'?t.amt:''}</td></tr>`).join('');
            el.innerHTML = `<h1 style="text-align:center">${cust.name} Statement</h1><p style="text-align:center">${fmtDate(s)} to ${fmtDate(e)}</p><table style="width:100%;border-collapse:collapse;margin-top:20px"><thead><tr style="background:#f2f2f2"><th>DATE</th><th>GAVE</th><th>GOT</th></tr></thead><tbody>${rows}</tbody></table>`;
            html2pdf().set({margin:10, filename:`${cust.name}.pdf`}).from(el).save();
            closeModal();
        }

        // --- QR CARD FIX ---
        function showQRCard(amt) {
            if(!db.upi) return alert("Please set UPI ID in Settings!");
            const cust = db.customers.find(c => c.id === activeCid);
            openModal(`
                <div class="qr-card-container">
                    <div class="qr-card-box">
                        <h2 style="font-weight:900; font-size:22px;">${cust.name}</h2>
                        <p style="font-size:12px; color:#666;">Please send money</p>
                        <div id="qrcode"></div>
                        <h1 style="font-weight:900; font-size:32px; color:#3b82f6;">₹${amt}</h1>
                        <p style="font-size:10px; color:#888; margin-top:5px;">${db.upi}</p>
                    </div>
                    <p class="text-[10px] mt-4 opacity-70">Long press QR to Share/Save Image</p>
                    <button class="w-full p-4 bg-gray-700 rounded-xl font-bold mt-4" onclick="closeModal()">CLOSE</button>
                </div>
            `);
            setTimeout(() => { new QRCode(document.getElementById("qrcode"), { text: `upi://pay?pa=${db.upi}&am=${amt}&cu=INR`, width: 220, height: 220 }); }, 100);
        }

        // --- ACTIONS ---
        function submitPromise(id) {
            const p = db.promises.find(x => x.id === id);
            db.trans.push({ id: Date.now(), cid: p.cid, type: 'GOT', amt: Number(p.amt), date: getToday() });
            db.promises = db.promises.filter(x => x.id !== id);
            saveDB();
        }
        function deletePromise(id) { if(confirm("Delete?")) { db.promises = db.promises.filter(x => x.id !== id); saveDB(); } }
        function sendWA(b) {
            const cust = db.customers.find(c => c.id === activeCid);
            let msg = b >= 0 ? `ഞാൻ നിങ്ങൾക്ക് ₹${Math.abs(b)} തരാനുണ്ട്.` : `നിങ്ങൾ എനിക്ക് ₹${Math.abs(b)} തരാനുണ്ട്.`;
            window.open(`https://wa.me/${cust.phone ? '91'+cust.phone : ''}?text=*KHATA PRO*%0AClient: *${cust.name}*%0A${msg}`);
        }

        // --- UTILS ---
        function openAddQuick(type) {
            let options = db.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            openModal(`<h2 class="font-bold mb-4 text-center">Quick ${type}</h2><select id="q_cid" class="w-full p-4 rounded-xl mb-3 text-black">${options}</select><input id="ta" type="number" class="w-full p-5 mb-3 rounded-2xl text-2xl font-black text-center text-blue-600" placeholder="₹ 0"><button class="w-full p-5 btn-primary rounded-2xl font-black" onclick="saveQuick('${type}')">SAVE</button>`);
        }
        function saveQuick(type) { let cid=Number(document.getElementById('q_cid').value), a=Number(document.getElementById('ta').value); if(cid&&a){ db.trans.push({id:Date.now(), cid, type, amt:a, date:getToday()}); saveDB(); closeModal(); } }
        function openAdd(type) { openModal(`<h2 class="font-bold mb-4 text-center">${type}</h2><input id="ta" type="number" class="w-full p-5 mb-3 rounded-2xl text-2xl font-black text-center text-blue-600" placeholder="₹ 0" autofocus><input id="td" type="date" class="w-full p-4 rounded-xl mb-4 text-black" value="${getToday()}"><button class="w-full p-5 btn-primary rounded-2xl font-black" onclick="saveTrans('${type}')">SAVE</button>`); }
        function saveTrans(type) { let a=Number(document.getElementById('ta').value), d=document.getElementById('td').value; if(a&&d){ db.trans.push({id:Date.now(), cid:activeCid, type, amt:a, date:d}); saveDB(); closeModal(); } }
        function openPromiseModal() { openModal(`<h2 class="text-xl font-bold mb-5 text-center">Promise</h2><input id="pa" type="number" class="w-full p-4 rounded-xl mb-3 text-black" placeholder="Amount"><input id="pd" type="date" class="w-full p-4 rounded-xl mb-4 text-black" value="${getToday()}"><button class="w-full p-5 btn-primary rounded-2xl font-black" onclick="savePromise()">CONFIRM</button>`); }
        function savePromise() { let a=document.getElementById('pa').value, d=document.getElementById('pd').value; if(a&&d){ db.promises.push({id:Date.now(), cid:activeCid, amt:a, date:d}); saveDB(); closeModal(); } }
        function openCustModal() { openModal(`<h2 class="text-xl font-bold mb-5">New Client</h2><input id="cn" class="w-full p-4 rounded-xl mb-3 text-black" placeholder="Name"><input id="cp" type="number" class="w-full p-4 rounded-xl mb-4 text-black" placeholder="Phone"><button class="w-full p-5 btn-primary rounded-2xl font-black" onclick="saveCust()">SAVE</button>`); }
        function saveCust() { let n=document.getElementById('cn').value; if(n){ db.customers.push({id:Date.now(), name:n, phone:document.getElementById('cp').value}); saveDB(); closeModal(); } }
        function openSettings() { openModal(`<h2 class="text-xl font-bold mb-4">Settings</h2><input id="upiI" class="w-full p-4 rounded-xl mb-3 text-black" value="${db.upi||''}" placeholder="UPI ID"><input id="pinI" maxlength="4" class="w-full p-4 rounded-xl mb-4 text-black" value="${db.pin}"><button class="w-full p-4 btn-primary rounded-xl font-black mb-4" onclick="db.upi=document.getElementById('upiI').value;db.pin=document.getElementById('pinI').value;saveDB();closeModal();">SAVE</button><div class="grid grid-cols-2 gap-2"><button onclick="exportBackup()" class="bg-green-600 p-4 rounded-xl text-xs font-bold">BACKUP</button><button onclick="document.getElementById('restoreFile').click()" class="bg-orange-600 p-4 rounded-xl text-xs font-bold">RESTORE</button></div><input type="file" id="restoreFile" class="hidden" accept=".json" onchange="importBackup(event)">`); }
        function exportBackup() { const blob = new Blob([JSON.stringify(db)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Khata_Backup.json`; a.click(); }
        function importBackup(e) { const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (ev) => { try { const imported = JSON.parse(ev.target.result); if(imported.customers) { db = imported; saveDB(); alert("Success!"); } } catch(e) { alert("Error!"); } }; reader.readAsText(file); }
        function openModal(h) { document.getElementById('modalBox').innerHTML=h; document.getElementById('modalOverlay').style.display='flex'; }
        function closeModal() { document.getElementById('modalOverlay').style.display='none'; }
        function goHome() { activeCid=null; render(); }

        render();
    </script>
</body>
</html>