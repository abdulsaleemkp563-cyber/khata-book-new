<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>KHATA PRO | Ultimate Ledger</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body.dark-mode { background: #0f172a; color: #f8fafc; }
        body.light-mode { background: #f8fafc; color: #0f172a; }
        
        .app { max-width: 480px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; position: relative; }
        
        /* Dashboard Styling */
        .dashboard-card { 
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); 
            padding: 40px 25px; 
            border-radius: 0 0 40px 40px; 
            text-align: center; 
            box-shadow: 0 15px 30px rgba(30, 64, 175, 0.4); 
            margin-bottom: 25px; 
            transition: all 0.3s;
        }
        
        .balance-amount { font-size: 48px; font-weight: 800; margin: 10px 0 25px 0; color: white; letter-spacing: -1px; }
        
        /* Search & Lists */
        .search-wrap { padding: 0 20px; margin-top: -45px; z-index: 10; margin-bottom: 20px; }
        .search-box { 
            width: 100%; padding: 18px 20px 18px 50px; border-radius: 25px; border: none; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); outline: none; transition: 0.3s;
        }
        .dark-mode .search-box { background: #1e293b; color: white; border: 1px solid #334155; }
        .light-mode .search-box { background: white; color: black; border: 1px solid #e2e8f0; }
        
        .cust-card { 
            display: flex; align-items: center; padding: 15px; border-radius: 24px; 
            margin-bottom: 12px; cursor: pointer; transition: transform 0.1s;
        }
        .cust-card:active { transform: scale(0.98); }
        .dark-mode .cust-card { background: #1e293b; }
        .light-mode .cust-card { background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }

        /* Transaction Table */
        .trans-card { 
            display: grid; grid-template-columns: 100px 1fr 1fr 1fr; 
            padding: 18px; border-radius: 20px; margin-bottom: 10px; 
            align-items: center; font-size: 13px; cursor: pointer;
        }
        .dark-mode .trans-card { background: #1e293b; border-bottom: 1px solid #334155; }
        .light-mode .trans-card { background: white; border-bottom: 1px solid #f1f5f9; }

        /* Modal Overlays */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); 
            display: none; align-items: flex-end; z-index: 1000; backdrop-filter: blur(8px); 
        }
        .modal { 
            width: 100%; max-width: 480px; padding: 30px 25px 45px 25px; 
            border-radius: 40px 40px 0 0; transform: translateY(100%); 
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); background: #1e293b; color: white; 
        }
        .light-mode .modal { background: #ffffff; color: #0f172a; }
        .modal.active { transform: translateY(0); }
        
        .input-field { 
            width: 100%; padding: 16px; border-radius: 18px; border: none; 
            background: rgba(128,128,128,0.1); color: inherit; outline: none; margin-bottom: 15px; 
        }
        
        .footer { position: fixed; bottom: 25px; width: 100%; max-width: 480px; padding: 0 20px; display: flex; gap: 12px; z-index: 50; }
        .btn-action { flex: 1; padding: 20px; border-radius: 22px; font-weight: 800; color: white; border: none; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        .fab { position: fixed; bottom: 30px; right: 25px; width: 65px; height: 65px; background: #2563eb; color: white; border-radius: 22px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4); border: none; z-index: 40; }

        @media print {
            .no-print { display: none !important; }
            #printArea { display: block !important; background: white; color: black; padding: 20px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        }
    </style>
</head>
<body class="dark-mode">

    <div class="app no-print">
        <div class="p-6 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <button id="backBtn" onclick="goHome()" class="hidden text-xl"><i class="fa-solid fa-chevron-left"></i></button>
                <h1 id="pageTitle" class="text-xl font-extrabold tracking-tight">KHATA PRO</h1>
            </div>
            <div class="flex gap-6 items-center">
                <button onclick="toggleTheme()"><i id="themeIcon" class="fa-solid fa-sun text-xl"></i></button>
                <button onclick="openBackup()"><i class="fa-solid fa-database text-xl"></i></button>
            </div>
        </div>

        <div id="mainContent" class="flex-1 overflow-y-auto px-1"></div>
        <div id="footerActions"></div>
    </div>

    <div id="printArea" class="hidden">
        <h1 class="text-2xl font-black">KHATA STATEMENT</h1>
        <p id="pNameDisplay" class="text-lg mt-2 font-bold"></p>
        <p class="text-sm opacity-50 mb-6">Generated on: <span id="pDate"></span></p>
        <table>
            <thead><tr><th>Date</th><th>Remark</th><th>Gave (Dr)</th><th>Got (Cr)</th></tr></thead>
            <tbody id="pBody"></tbody>
        </table>
        <div class="mt-8 text-right">
            <h2 id="pNet" class="text-xl font-black"></h2>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
        <div class="modal" id="modalBox" onclick="event.stopPropagation()"></div>
    </div>

    <script>
        const STORAGE_ID = 'KHATA_PRO_DATA_V22';
        let db = JSON.parse(localStorage.getItem(STORAGE_ID)) || { customers: [], trans: [], darkMode: true };
        let activeCid = null;
        let searchQuery = "";
        const colors = ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#ef4444', '#3b82f6'];

        function saveDB() { localStorage.setItem(STORAGE_ID, JSON.stringify(db)); render(); }
        
        function applyTheme() {
            document.body.className = db.darkMode ? 'dark-mode' : 'light-mode';
            document.getElementById('themeIcon').className = db.darkMode ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        }
        
        function toggleTheme() { db.darkMode = !db.darkMode; applyTheme(); saveDB(); }

        function render() { activeCid ? renderDetails() : renderHome(); }

        function renderHome() {
            activeCid = null;
            document.getElementById('backBtn').classList.add('hidden');
            document.getElementById('pageTitle').innerText = "KHATA PRO";
            document.getElementById('footerActions').innerHTML = '';
            
            let give = 0, got = 0;
            db.trans.forEach(t => { if(t.type === 'GAVE') give += t.amt; else got += t.amt; });
            const bal = give - got;

            document.getElementById('mainContent').innerHTML = `
                <div class="dashboard-card">
                    <div class="text-[11px] font-bold opacity-80 uppercase tracking-widest">Global Balance</div>
                    <div class="balance-amount">₹${bal.toLocaleString()}</div>
                    <div class="stat-grid grid grid-cols-2 gap-4 bg-black/10 p-4 rounded-3xl">
                        <div class="text-center"><span class="block text-[10px] opacity-60 uppercase font-bold">You Give</span><span class="font-bold text-red-200 text-lg">₹${give}</span></div>
                        <div class="text-center border-l border-white/10"><span class="block text-[10px] opacity-60 uppercase font-bold">You Get</span><span class="font-bold text-green-200 text-lg">₹${got}</span></div>
                    </div>
                </div>
                <div class="search-wrap">
                    <div class="relative">
                        <i class="fa-solid fa-magnifying-glass absolute left-5 top-5 opacity-30"></i>
                        <input type="text" class="search-box" placeholder="Search customer..." oninput="searchQuery=this.value; renderHomeList()">
                    </div>
                </div>
                <div class="list-container px-4" id="custContainer"></div>
                <button class="fab no-print" onclick="openCustomerModal()"><i class="fa-solid fa-user-plus"></i></button>`;
            renderHomeList();
        }

        function renderHomeList() {
            const container = document.getElementById('custContainer');
            let filtered = db.customers.filter(c => c.name.toLowerCase().includes(searchQuery.toLowerCase()));
            
            if(filtered.length === 0) {
                container.innerHTML = `<div class="text-center opacity-30 mt-10">No customers found</div>`;
                return;
            }

            let html = `<h3 class="text-[10px] font-black opacity-30 mb-4 uppercase tracking-tighter">Your Customers</h3>`;
            filtered.forEach((c, i) => {
                let bal = 0;
                db.trans.filter(t => t.cid === c.id).forEach(t => bal += (t.type === 'GAVE' ? t.amt : -t.amt));
                html += `
                <div class="cust-card" onclick="viewCust(${c.id})">
                    <div class="avatar h-12 w-12 rounded-2xl flex items-center justify-center font-bold text-white mr-4" style="background:${colors[i % colors.length]}">${c.name[0].toUpperCase()}</div>
                    <div class="flex-1">
                        <b class="text-base font-bold">${c.name}</b>
                        <p class="text-[11px] opacity-40 font-medium">${c.phone || 'No phone'}</p>
                    </div>
                    <div class="text-right">
                        <b class="${bal >= 0 ? 'text-red-500' : 'text-green-500'} text-lg">₹${Math.abs(bal)}</b>
                        <i class="fa-solid fa-chevron-right text-[10px] opacity-20 ml-2"></i>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function viewCust(id) { activeCid = id; render(); }
        function goHome() { activeCid = null; render(); }

        function renderDetails() {
            const cust = db.customers.find(c => c.id === activeCid);
            document.getElementById('backBtn').classList.remove('hidden');
            document.getElementById('pageTitle').innerText = cust.name;
            
            let rawTrans = db.trans.filter(t => t.cid === activeCid).sort((a,b) => new Date(a.date) - new Date(b.date));
            let tGive = 0, tGot = 0, runningBal = 0;
            let displayList = [];
            
            rawTrans.forEach(t => {
                if(t.type === 'GAVE') tGive += t.amt; else tGot += t.amt;
                runningBal += (t.type === 'GAVE' ? t.amt : -t.amt);
                displayList.unshift({ ...t, currentBal: Math.abs(runningBal) });
            });

            document.getElementById('mainContent').innerHTML = `
                <div class="dashboard-card" style="padding: 30px 20px;">
                    <div class="balance-amount" style="font-size: 42px;">₹${Math.abs(tGive - tGot)}</div>
                    <div class="flex justify-center gap-3">
                        <button class="bg-white/20 px-6 py-3 rounded-2xl font-bold text-xs" onclick="openCustomerModal(${activeCid})">PROFILE</button>
                        <button class="bg-white text-blue-600 px-6 py-3 rounded-2xl font-bold text-xs" onclick="printReport()">PDF REPORT</button>
                    </div>
                </div>
                <div class="list-container pb-32">
                    <div class="flex justify-between px-4 mb-4 opacity-40 text-[10px] font-black uppercase tracking-widest">
                        <span>Transaction</span>
                        <span>Debit</span>
                        <span>Credit</span>
                        <span>Balance</span>
                    </div>
                    ${displayList.map(t => `
                    <div class="trans-card" onclick="openTransModal('${t.type}', ${t.id})">
                        <div><div class="font-bold text-xs">${t.date.split('-').reverse().join('/')}</div><div class="text-[10px] opacity-40 truncate">${t.remark || '-'}</div></div>
                        <div class="font-bold text-red-500 text-center">${t.type==='GAVE' ? '₹'+t.amt : '-'}</div>
                        <div class="font-bold text-green-500 text-center">${t.type==='GOT' ? '₹'+t.amt : '-'}</div>
                        <div class="font-black text-right">₹${t.currentBal}</div>
                    </div>`).join('')}
                </div>`;
            
            document.getElementById('footerActions').innerHTML = `
                <div class="footer">
                    <button class="btn-action bg-red-500" onclick="openTransModal('GAVE')">GAVE ₹</button>
                    <button class="btn-action bg-green-600" onclick="openTransModal('GOT')">GOT ₹</button>
                </div>`;
        }

        function openModal(content) {
            document.getElementById('modalBox').innerHTML = content;
            document.getElementById('modalOverlay').style.display = 'flex';
            setTimeout(() => document.getElementById('modalBox').classList.add('active'), 10);
        }

        function closeModal() {
            document.getElementById('modalBox').classList.remove('active');
            setTimeout(() => document.getElementById('modalOverlay').style.display = 'none', 300);
        }

        function openCustomerModal(id = null) {
            const c = id ? db.customers.find(x => x.id === id) : { name: '', phone: '' };
            openModal(`
                <div class="flex justify-between items-center mb-6"><h2 class="font-black uppercase">Customer Profile</h2>${id ? `<button onclick="deleteCust(${id})" class="text-red-500 text-xs font-bold">DELETE USER</button>` : ''}</div>
                <input type="text" id="cName" class="input-field" value="${c.name}" placeholder="Full Name">
                <input type="number" id="cPhone" class="input-field" value="${c.phone || ''}" placeholder="WhatsApp No (e.g. 9198...)">
                <button class="w-full py-5 bg-blue-600 rounded-2xl font-black mt-2" onclick="saveCustomer(${id})">SAVE PROFILE</button>
            `);
        }

        function saveCustomer(id) {
            const name = document.getElementById('cName').value.trim();
            const phone = document.getElementById('cPhone').value.trim();
            if(!name) return alert("Name is required");
            if(id) { let x = db.customers.find(y => y.id === id); x.name = name; x.phone = phone; }
            else { db.customers.push({ id: Date.now(), name, phone }); }
            saveDB(); closeModal();
        }

        function deleteCust(id) {
            if(confirm("Permanently delete this customer and all data?")) {
                db.customers = db.customers.filter(c => c.id !== id);
                db.trans = db.trans.filter(t => t.cid !== id);
                saveDB(); closeModal(); goHome();
            }
        }

        function openTransModal(type, editId = null) {
            const t = editId ? db.trans.find(x => x.id === editId) : { amt: '', remark: '', date: new Date().toISOString().split('T')[0] };
            openModal(`
                <h2 class="mb-6 text-center font-black uppercase tracking-widest ${type==='GAVE'?'text-red-500':'text-green-500'}">${editId ? 'Edit' : 'New'} ${type}</h2>
                <input type="number" id="tAmt" class="input-field text-4xl text-center font-black" value="${t.amt}" placeholder="₹0">
                <input type="text" id="tRemark" class="input-field" value="${t.remark}" placeholder="Notes/Remark">
                <input type="date" id="tDate" class="input-field" value="${t.date}">
                <div class="flex gap-3 mt-4">
                    ${editId ? `<button class="flex-1 py-4 bg-red-500/10 text-red-500 rounded-2xl font-bold" onclick="deleteTrans(${editId})">DELETE</button>` : ''}
                    <button class="flex-[2] py-4 bg-blue-600 rounded-2xl font-black" onclick="saveTrans('${type}', ${editId})">SAVE & SEND MSG</button>
                </div>
            `);
        }

        function saveTrans(type, id) {
            const amt = parseFloat(document.getElementById('tAmt').value);
            const date = document.getElementById('tDate').value;
            const remark = document.getElementById('tRemark').value;
            if(!amt) return alert("Enter amount");
            
            if(id) { let x = db.trans.find(y => y.id === id); x.amt = amt; x.date = date; x.remark = remark; }
            else { db.trans.push({ id: Date.now(), cid: activeCid, type, amt, date, remark }); }
            
            saveDB(); closeModal();
            sendAutoMsg(activeCid, type, amt, remark);
        }

        function deleteTrans(id) {
            if(confirm("Delete this entry?")) {
                db.trans = db.trans.filter(t => t.id !== id);
                saveDB(); closeModal();
            }
        }

        function sendAutoMsg(cid, type, amt, remark) {
            const cust = db.customers.find(c => c.id === cid);
            if(!cust || !cust.phone) return;
            let bal = 0;
            db.trans.filter(t => t.cid === cid).forEach(t => bal += (t.type === 'GAVE' ? t.amt : -t.amt));
            
            const msg = `*KHATA PRO UPDATE*%0A------------------------%0A*Name:* ${cust.name}%0A*Amount:* ₹${amt}%0A*Type:* ${type === 'GAVE' ? 'Debit (കൊടുത്തു)' : 'Credit (കിട്ടി)'}%0A*Remark:* ${remark || '-'}%0A------------------------%0A*Current Balance: ₹${Math.abs(bal)}*`;
            
            if(confirm("Open WhatsApp to notify customer?")) {
                window.open(`https://wa.me/${cust.phone}?text=${msg}`, '_blank');
            }
        }

        function openBackup() {
            openModal(`
                <h2 class="mb-6 text-center font-black uppercase tracking-widest">Database Management</h2>
                <button class="w-full p-5 bg-emerald-600 rounded-2xl mb-4 font-black" onclick="exportJSON()"><i class="fa-solid fa-file-export mr-2"></i> DOWNLOAD BACKUP</button>
                <button class="w-full p-5 bg-blue-600 rounded-2xl font-black" onclick="document.getElementById('fInp').click()"><i class="fa-solid fa-file-import mr-2"></i> RESTORE FROM FILE</button>
                <input type="file" id="fInp" class="hidden" onchange="importJSON(event)">
                <p class="text-[10px] text-center mt-6 opacity-40 font-bold uppercase">Store this file safely to restore data later.</p>
            `);
        }

        function exportJSON() {
            const blob = new Blob([JSON.stringify(db)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `KHATA_BACKUP_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importJSON(e) {
            const r = new FileReader();
            r.onload = (ev) => {
                try {
                    db = JSON.parse(ev.target.result);
                    saveDB();
                    location.reload();
                } catch(e) { alert("Invalid Backup File!"); }
            };
            r.readAsText(e.target.files[0]);
        }

        function printReport() {
            const cust = db.customers.find(c => c.id === activeCid);
            document.getElementById('pNameDisplay').innerText = "Name: " + cust.name;
            document.getElementById('pDate').innerText = new Date().toLocaleString();
            const trans = db.trans.filter(t => t.cid === activeCid).sort((a,b) => new Date(a.date) - new Date(b.date));
            let html = ''; let bal = 0;
            trans.forEach(t => {
                bal += (t.type === 'GAVE' ? t.amt : -t.amt);
                html += `<tr><td>${t.date}</td><td>${t.remark || '-'}</td><td style="color:red">${t.type==='GAVE'?t.amt:'-'}</td><td style="color:green">${t.type==='GOT'?t.amt:'-'}</td></tr>`;
            });
            document.getElementById('pBody').innerHTML = html;
            document.getElementById('pNet').innerText = "Total Balance: ₹" + Math.abs(bal);
            window.print();
        }

        window.onload = () => { applyTheme(); render(); };
    </script>
</body>
</html>